# ğŸ” æ•…éšœæ’é™¤ç¯‡ï¼šè¨ºæ–·èˆ‡ä¿®å¾©æŒ‡å—

## ğŸ¯ æœ¬ç¯‡å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç¯‡å¾Œï¼Œæ‚¨å°‡ï¼š
- âœ… æŒæ¡ç³»çµ±æ€§çš„æ•…éšœè¨ºæ–·æ–¹æ³•
- âœ… å¿«é€Ÿè­˜åˆ¥å¸¸è¦‹å•é¡Œçš„ç—‡ç‹€å’Œæ ¹å› 
- âœ… ç†Ÿç·´ä½¿ç”¨å„ç¨®è¨ºæ–·å·¥å…·
- âœ… å…·å‚™ç¨ç«‹è§£æ±º 95% å¸¸è¦‹å•é¡Œçš„èƒ½åŠ›
- âœ… å»ºç«‹æ¨™æº–åŒ–çš„æ•…éšœæ’é™¤æµç¨‹

## ğŸ“‹ æ•…éšœè¨ºæ–·ç¸½è¦½

### ğŸš¨ å¸¸è¦‹æ•…éšœåˆ†é¡

```mermaid
%%{init: {'theme': 'dark', 'themeVariables': { 'fontSize': '20px', 'fontFamily': 'Arial' }}}%%
graph TD
    A[éƒ¨ç½²æ•…éšœ] --> B[èªè­‰å•é¡Œ]
    A --> C[é…ç½®éŒ¯èª¤]
    A --> D[æ¬Šé™å•é¡Œ]
    A --> E[API é™åˆ¶]
    
    B --> B1[Token éæœŸ]
    B --> B2[Secret æ ¼å¼éŒ¯èª¤]
    B --> B3[API æœªå•Ÿç”¨]
    
    C --> C1[Script ID éŒ¯èª¤]
    C --> C2[æª”æ¡ˆè·¯å¾‘å•é¡Œ]
    C --> C3[Workflow é…ç½®éŒ¯èª¤]
    
    D --> D1[å°ˆæ¡ˆæ¬Šé™ä¸è¶³]
    D --> D2[GitHub Actions æ¬Šé™]
    D --> D3[Apps Script åˆ†äº«è¨­å®š]
    
    E --> E1[API é…é¡è¶…é™]
    E --> E2[é »ç‡é™åˆ¶]
    E --> E3[æœå‹™æš«æ™‚ä¸å¯ç”¨]
    
    style A fill:#ef4444,stroke:#dc2626,color:#fff
    style B fill:#f59e0b,stroke:#d97706,color:#fff
    style C fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style D fill:#06b6d4,stroke:#0891b2,color:#fff
    style E fill:#10b981,stroke:#059669,color:#fff
```

### ğŸ“Š æ•…éšœç™¼ç”Ÿé »ç‡çµ±è¨ˆ

åŸºæ–¼çœŸå¯¦é–‹ç™¼ç¶“é©—çš„çµ±è¨ˆæ•¸æ“šï¼š

| æ•…éšœé¡å‹ | ç™¼ç”Ÿé »ç‡ | åš´é‡ç¨‹åº¦ | å¹³å‡ä¿®å¾©æ™‚é–“ | è¨ºæ–·é›£åº¦ |
|---------|---------|---------|-------------|----------|
| **Token éæœŸ** | 90% | ğŸ”´ é«˜ | 15 åˆ†é˜ | â­ ç°¡å–® |
| **Script ID éŒ¯èª¤** | 60% | ğŸ”´ é«˜ | 30 åˆ†é˜ | â­â­ ä¸­ç­‰ |
| **Secret é…ç½®éŒ¯èª¤** | 80% | ğŸŸ¡ ä¸­ | 10 åˆ†é˜ | â­ ç°¡å–® |
| **æ¬Šé™è¨­ç½®å•é¡Œ** | 40% | ğŸŸ¡ ä¸­ | 20 åˆ†é˜ | â­â­ ä¸­ç­‰ |
| **API æœªå•Ÿç”¨** | 50% | ğŸŸ¡ ä¸­ | 5 åˆ†é˜ | â­ ç°¡å–® |
| **èªè­‰æ–¹å¼éŒ¯èª¤** | 30% | ğŸ”´ é«˜ | 2 å°æ™‚ | â­â­â­â­ å›°é›£ |
| **ç¶²è·¯é€£ç·šå•é¡Œ** | 10% | ğŸŸ¢ ä½ | ç­‰å¾…è§£æ±º | â­ ç°¡å–® |

## ğŸ› ï¸ æ ¸å¿ƒè¨ºæ–·å·¥å…·

### 1. å¿«é€Ÿè¨ºæ–·è…³æœ¬

å»ºç«‹ä¸€å€‹ç¶œåˆè¨ºæ–·å·¥å…·ï¼Œæ¶µè“‹æ‰€æœ‰å¸¸è¦‹å•é¡Œæª¢æŸ¥ï¼š

```cmd
@echo off
REM === GitHub Actions + Apps Script æ•…éšœè¨ºæ–·å·¥å…· ===
echo ğŸ” è‡ªå‹•éƒ¨ç½²æ•…éšœè¨ºæ–·å·¥å…·
echo ================================
echo.

REM è¨­å®šå°ˆæ¡ˆè®Šæ•¸ (è«‹æ ¹æ“šå¯¦éš›å°ˆæ¡ˆä¿®æ”¹)
set SCRIPT_ID=1KXfXrs_yXXguMXsXyKXoXXnxXJXLGXyAhXXJCbXXMy-lrXAhXE91axXJ
set REPO_NAME=XXXeorgtw/vote-time
set MAIN_BRANCH=main

echo ğŸ“‹ å°ˆæ¡ˆè³‡è¨Šç¢ºèª:
echo   Script ID: %SCRIPT_ID%
echo   Repository: https://github.com/%REPO_NAME%
echo   ä¸»åˆ†æ”¯: %MAIN_BRANCH%
echo.

REM 1. æª¢æŸ¥åŸºæœ¬ç’°å¢ƒ
echo ğŸ”§ æ­¥é©Ÿ 1: æª¢æŸ¥åŸºæœ¬ç’°å¢ƒ
echo --------------------------------
call :check_command "Node.js" "node --version"
call :check_command "npm" "npm --version"
call :check_command "clasp" "clasp --version"
call :check_command "Git" "git --version"
echo.

REM 2. æª¢æŸ¥ clasp èªè­‰ç‹€æ…‹
echo ğŸ” æ­¥é©Ÿ 2: æª¢æŸ¥ clasp èªè­‰ç‹€æ…‹
echo --------------------------------
echo æ­£åœ¨æª¢æŸ¥ clasp ç™»å…¥ç‹€æ…‹...
clasp status >nul 2>&1
if %errorlevel% equ 0 (
    echo âœ… clasp å·²æ­£ç¢ºèªè­‰
    clasp whoami 2>nul
) else (
    echo âŒ clasp èªè­‰å¤±æ•—
    echo ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ: åŸ·è¡Œ 'clasp login' é‡æ–°èªè­‰
)
echo.

REM 3. æª¢æŸ¥å°ˆæ¡ˆé…ç½®
echo ğŸ“ æ­¥é©Ÿ 3: æª¢æŸ¥å°ˆæ¡ˆé…ç½®
echo --------------------------------
if exist ".clasp.json" (
    echo âœ… .clasp.json å­˜åœ¨
    
    REM æª¢æŸ¥ Script ID æ ¼å¼
    findstr /C:"scriptId" .clasp.json >nul
    if %errorlevel% equ 0 (
        echo âœ… æ‰¾åˆ° scriptId é…ç½®
        type .clasp.json | findstr "scriptId"
    ) else (
        echo âŒ .clasp.json ä¸­ç¼ºå°‘ scriptId
    )
) else (
    echo âŒ .clasp.json ä¸å­˜åœ¨
    echo ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ: åŸ·è¡Œ 'clasp create' æˆ–æ‰‹å‹•å‰µå»ºé…ç½®æª”æ¡ˆ
)
echo.

REM 4. æª¢æŸ¥ Apps Script æª”æ¡ˆ
echo ğŸ“„ æ­¥é©Ÿ 4: æª¢æŸ¥ Apps Script æª”æ¡ˆ
echo --------------------------------
set FILE_COUNT=0
for %%f in (*.gs *.html appsscript.json) do (
    set /a FILE_COUNT+=1
    echo âœ… æ‰¾åˆ°: %%f
)
echo ğŸ“Š ç¸½è¨ˆ %FILE_COUNT% å€‹æª”æ¡ˆ
if %FILE_COUNT% equ 0 (
    echo âš ï¸  è­¦å‘Š: æ²’æœ‰æ‰¾åˆ° Apps Script æª”æ¡ˆ
)
echo.

REM 5. æª¢æŸ¥ Git ç‹€æ…‹
echo ğŸŒ¿ æ­¥é©Ÿ 5: æª¢æŸ¥ Git ç‹€æ…‹
echo --------------------------------
git status >nul 2>&1
if %errorlevel% equ 0 (
    echo âœ… Git repository å·²åˆå§‹åŒ–
    
    git remote -v | findstr origin >nul
    if %errorlevel% equ 0 (
        echo âœ… Git remote å·²è¨­ç½®
        git remote -v
    ) else (
        echo âŒ Git remote æœªè¨­ç½®
        echo ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ: git remote add origin https://github.com/%REPO_NAME%.git
    )
) else (
    echo âŒ ä¸æ˜¯ Git repository
    echo ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ: åŸ·è¡Œ 'git init' åˆå§‹åŒ–
)
echo.

REM 6. æª¢æŸ¥ GitHub Actions é…ç½®
echo âš™ï¸ æ­¥é©Ÿ 6: æª¢æŸ¥ GitHub Actions é…ç½®
echo --------------------------------
if exist ".github\workflows\deploy-to-gas.yml" (
    echo âœ… GitHub Actions workflow å­˜åœ¨
    
    findstr /C:"CLASPRC_JSON" .github\workflows\deploy-to-gas.yml >nul
    if %errorlevel% equ 0 (
        echo âœ… workflow ä½¿ç”¨ OAuth èªè­‰ (æ¨è–¦)
    ) else (
        findstr /C:"GOOGLE_SERVICE_ACCOUNT_KEY" .github\workflows\deploy-to-gas.yml >nul
        if %errorlevel% equ 0 (
            echo âš ï¸  workflow ä½¿ç”¨ Service Account (å¯èƒ½æœ‰å•é¡Œ)
            echo ğŸ’¡ å»ºè­°: åˆ‡æ›åˆ° OAuth èªè­‰æ–¹å¼
        ) else (
            echo âŒ workflow ç¼ºå°‘èªè­‰é…ç½®
        )
    )
) else (
    echo âŒ GitHub Actions workflow ä¸å­˜åœ¨
    echo ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ: å‰µå»º .github\workflows\deploy-to-gas.yml
)
echo.

REM 7. æ¸¬è©¦ç¶²è·¯é€£ç·š
echo ğŸŒ æ­¥é©Ÿ 7: æ¸¬è©¦ç¶²è·¯é€£ç·š
echo --------------------------------
ping google.com -n 1 >nul 2>&1
if %errorlevel% equ 0 (
    echo âœ… ç¶²è·¯é€£ç·šæ­£å¸¸
) else (
    echo âŒ ç¶²è·¯é€£ç·šç•°å¸¸
    echo ğŸ’¡ è«‹æª¢æŸ¥ç¶²è·¯è¨­å®šå’Œé˜²ç«ç‰†
)

curl -s https://script.googleapis.com/ >nul 2>&1
if %errorlevel% equ 0 (
    echo âœ… Google Apps Script API å¯é”
) else (
    echo âš ï¸  Google Apps Script API é€£ç·šç•°å¸¸
)
echo.

REM 8. ç¸½çµå ±å‘Š
echo ğŸ“‹ è¨ºæ–·ç¸½çµ
echo ================================
echo å®ŒæˆåŸºæœ¬ç’°å¢ƒè¨ºæ–·ã€‚
echo.
echo ğŸ” è©³ç´°å•é¡Œåˆ†æï¼š
echo   å¦‚æœç™¼ç¾å•é¡Œï¼Œè«‹åƒè€ƒä¸Šæ–¹çš„è§£æ±ºæ–¹æ¡ˆ
echo   æˆ–åŸ·è¡Œå°æ‡‰çš„ä¿®å¾©å‘½ä»¤
echo.
echo ğŸ†˜ å¦‚éœ€é€²ä¸€æ­¥å”åŠ©ï¼š
echo   1. æª¢æŸ¥ GitHub Actions åŸ·è¡Œæ—¥èªŒ
echo   2. ç¢ºèª GitHub Secrets è¨­ç½®
echo   3. åŸ·è¡Œ 'clasp push --force' æ‰‹å‹•æ¸¬è©¦
echo.
goto :eof

REM å·¥å…·å‡½æ•¸ï¼šæª¢æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
:check_command
%~2 >nul 2>&1
if %errorlevel% equ 0 (
    echo âœ… %~1 å·²å®‰è£
    %~2 2>nul
) else (
    echo âŒ %~1 æœªå®‰è£æˆ–ç„¡æ³•åŸ·è¡Œ
)
goto :eof
```

### 2. OAuth èªè­‰å°ˆç”¨è¨ºæ–·å·¥å…·

```cmd
@echo off
REM === OAuth èªè­‰å°ˆç”¨è¨ºæ–·å·¥å…· ===
echo ğŸ” OAuth èªè­‰è¨ºæ–·å·¥å…·
echo ========================

set CLASPRC_PATH=%USERPROFILE%\.clasprc.json

echo ğŸ“‹ æª¢æŸ¥ OAuth èªè­‰ç‹€æ…‹...
echo.

REM æª¢æŸ¥èªè­‰æª”æ¡ˆæ˜¯å¦å­˜åœ¨
if exist "%CLASPRC_PATH%" (
    echo âœ… èªè­‰æª”æ¡ˆå­˜åœ¨: %CLASPRC_PATH%
    
    REM æª¢æŸ¥æª”æ¡ˆå¤§å°
    for %%A in ("%CLASPRC_PATH%") do set FILE_SIZE=%%~zA
    echo ğŸ“Š æª”æ¡ˆå¤§å°: %FILE_SIZE% bytes
    
    if %FILE_SIZE% gtr 100 (
        echo âœ… æª”æ¡ˆå¤§å°æ­£å¸¸
    ) else (
        echo âŒ æª”æ¡ˆéå°ï¼Œå¯èƒ½æå£
    )
    
    REM æª¢æŸ¥ JSON æ ¼å¼
    echo.
    echo ğŸ” æª¢æŸ¥ JSON æ ¼å¼...
    
    findstr /C:"access_token" "%CLASPRC_PATH%" >nul
    if %errorlevel% equ 0 (
        echo âœ… æ‰¾åˆ° access_token
    ) else (
        echo âŒ ç¼ºå°‘ access_token
    )
    
    findstr /C:"refresh_token" "%CLASPRC_PATH%" >nul
    if %errorlevel% equ 0 (
        echo âœ… æ‰¾åˆ° refresh_token
    ) else (
        echo âŒ ç¼ºå°‘ refresh_token
    )
    
    findstr /C:"expiry_date" "%CLASPRC_PATH%" >nul
    if %errorlevel% equ 0 (
        echo âœ… æ‰¾åˆ° expiry_date
    ) else (
        echo âŒ ç¼ºå°‘ expiry_date
    )
    
) else (
    echo âŒ èªè­‰æª”æ¡ˆä¸å­˜åœ¨: %CLASPRC_PATH%
    echo.
    echo ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ:
    echo   1. åŸ·è¡Œ 'clasp login' é‡æ–°èªè­‰
    echo   2. ç¢ºèªç¶²è·¯é€£ç·šæ­£å¸¸
    echo   3. æª¢æŸ¥é˜²ç«ç‰†è¨­å®š
    goto :end
)

echo.
echo ğŸ§ª æ¸¬è©¦ clasp é€£ç·š...
clasp status
if %errorlevel% equ 0 (
    echo âœ… clasp é€£ç·šæ¸¬è©¦æˆåŠŸ
) else (
    echo âŒ clasp é€£ç·šæ¸¬è©¦å¤±æ•—
    echo.
    echo ğŸ’¡ å¯èƒ½åŸå› :
    echo   1. Token å·²éæœŸ
    echo   2. ç¶²è·¯é€£ç·šå•é¡Œ
    echo   3. Apps Script API æœªå•Ÿç”¨
    echo.
    echo ğŸ”§ å»ºè­°è§£æ±ºæ–¹æ¡ˆ:
    echo   1. é‡æ–°åŸ·è¡Œ 'clasp login'
    echo   2. æª¢æŸ¥ https://script.google.com/home/usersettings
    echo   3. ç¢ºèª Google å¸³æˆ¶ç‹€æ…‹æ­£å¸¸
)

echo.
echo ğŸ“‹ èªè­‰æª”æ¡ˆå…§å®¹é è¦½ (å®‰å…¨æˆªå–):
echo ----------------------------------------
if exist "%CLASPRC_PATH%" (
    echo {
    findstr /C:"access_token" "%CLASPRC_PATH%" | head -c 50
    echo ...
    findstr /C:"refresh_token" "%CLASPRC_PATH%" | head -c 50  
    echo ...
    findstr /C:"expiry_date" "%CLASPRC_PATH%"
    echo }
)

:end
echo.
echo ğŸ“‹ OAuth è¨ºæ–·å®Œæˆ
echo å¦‚éœ€æ›´æ–°èªè­‰ï¼Œè«‹åŸ·è¡Œ: clasp login
```

### 3. GitHub Actions æ—¥èªŒåˆ†æå·¥å…·

é‡å° GitHub Actions å¤±æ•—çš„æ—¥èªŒåˆ†ææŒ‡å—ï¼š

#### å¸¸è¦‹éŒ¯èª¤è¨Šæ¯è§£æ

| éŒ¯èª¤è¨Šæ¯ | å¯èƒ½åŸå›  | è§£æ±ºæ–¹æ¡ˆ |
|---------|---------|----------|
| `Error: Missing required parameter: CLASPRC_JSON` | GitHub Secrets æœªè¨­ç½® | è¨­ç½® `CLASPRC_JSON` Secret |
| `Error: Script ID is invalid` | `.clasp.json` ä¸­çš„ Script ID éŒ¯èª¤ | ç¢ºèªä¸¦æ›´æ–°æ­£ç¢ºçš„ Script ID |
| `Error: 401 UNAUTHENTICATED` | OAuth Token éæœŸ | é‡æ–°åŸ·è¡Œ `clasp login` ä¸¦æ›´æ–° Secret |
| `Error: 403 FORBIDDEN` | æ¬Šé™ä¸è¶³æˆ– API æœªå•Ÿç”¨ | æª¢æŸ¥å°ˆæ¡ˆæ¬Šé™å’Œ API å•Ÿç”¨ç‹€æ…‹ |
| `Error: Push failed` | æª”æ¡ˆæ¨é€å¤±æ•— | æª¢æŸ¥æª”æ¡ˆæ ¼å¼å’Œå…§å®¹ |

#### GitHub Actions æ—¥èªŒæª¢æŸ¥æ¸…å–®

```yaml
# åœ¨ GitHub Actions ä¸­åŠ å…¥æ›´è©³ç´°çš„è¨ºæ–·æ­¥é©Ÿ
- name: Detailed Diagnostics
  if: failure()
  run: |
    echo "=== è©³ç´°è¨ºæ–·è³‡è¨Š ==="
    
    # æª¢æŸ¥èªè­‰æª”æ¡ˆ
    echo "ğŸ” æª¢æŸ¥èªè­‰æª”æ¡ˆ:"
    if [ -f ~/.clasprc.json ]; then
      echo "âœ… .clasprc.json å­˜åœ¨"
      echo "ğŸ“Š æª”æ¡ˆå¤§å°: $(wc -c < ~/.clasprc.json) bytes"
      
      # æª¢æŸ¥ JSON çµæ§‹ (ä¸æ´©éœ²å…§å®¹)
      if jq empty ~/.clasprc.json; then
        echo "âœ… JSON æ ¼å¼æ­£ç¢º"
        echo "ğŸ”‘ Token é¡å‹: $(jq -r '.token_type' ~/.clasprc.json)"
        echo "â° åˆ°æœŸæ™‚é–“: $(jq -r '.expiry_date' ~/.clasprc.json)"
      else
        echo "âŒ JSON æ ¼å¼éŒ¯èª¤"
      fi
    else
      echo "âŒ .clasprc.json ä¸å­˜åœ¨"
    fi
    
    # æª¢æŸ¥å°ˆæ¡ˆé…ç½®
    echo "ğŸ“ æª¢æŸ¥å°ˆæ¡ˆé…ç½®:"
    if [ -f .clasp.json ]; then
      echo "âœ… .clasp.json å­˜åœ¨"
      echo "ğŸ¯ Script ID: $(jq -r '.scriptId' .clasp.json)"
    else
      echo "âŒ .clasp.json ä¸å­˜åœ¨"
    fi
    
    # æª¢æŸ¥æª”æ¡ˆæ¸…å–®
    echo "ğŸ“„ æª¢æŸ¥æ¨é€æª”æ¡ˆ:"
    find . -maxdepth 1 \( -name "*.gs" -o -name "*.html" -o -name "appsscript.json" \) | while read file; do
      echo "  â€¢ $file ($(wc -c < "$file") bytes)"
    done
    
    # æª¢æŸ¥ç¶²è·¯é€£ç·š
    echo "ğŸŒ æª¢æŸ¥ç¶²è·¯é€£ç·š:"
    if curl -s https://script.googleapis.com/ > /dev/null; then
      echo "âœ… Apps Script API å¯é”"
    else
      echo "âŒ Apps Script API é€£ç·šå¤±æ•—"
    fi
```

## ğŸ”¬ ç—‡ç‹€è¨ºæ–·å°ç…§è¡¨

### ç—‡ç‹€åˆ†é¡è¨ºæ–·æ³•

#### ğŸ”´ å®Œå…¨ç„¡æ³•éƒ¨ç½²é¡

**ç—‡ç‹€è¡¨ç¾**ï¼š
- GitHub Actions åŸ·è¡Œå¤±æ•—
- é¡¯ç¤ºèªè­‰éŒ¯èª¤
- clasp å‘½ä»¤ç„¡æ³•åŸ·è¡Œ

**è¨ºæ–·æµç¨‹**ï¼š

```mermaid
%%{init: {'theme': 'dark', 'themeVariables': { 'fontSize': '20px', 'fontFamily': 'Arial' }}}%%
flowchart TD
    A[éƒ¨ç½²å®Œå…¨å¤±æ•—] --> B{æª¢æŸ¥ GitHub Actions æ—¥èªŒ}
    B -->|401 éŒ¯èª¤| C[Token éæœŸå•é¡Œ]
    B -->|403 éŒ¯èª¤| D[æ¬Šé™å•é¡Œ]
    B -->|404 éŒ¯èª¤| E[Script ID éŒ¯èª¤]
    B -->|500 éŒ¯èª¤| F[Google æœå‹™å•é¡Œ]
    
    C --> C1[é‡æ–°åŸ·è¡Œ clasp login]
    C1 --> C2[æ›´æ–° CLASPRC_JSON Secret]
    
    D --> D1[æª¢æŸ¥å°ˆæ¡ˆåˆ†äº«è¨­å®š]
    D1 --> D2[ç¢ºèª API å•Ÿç”¨ç‹€æ…‹]
    
    E --> E1[ç¢ºèª .clasp.json ä¸­çš„ scriptId]
    E1 --> E2[å¾ Apps Script ç·¨è¼¯å™¨ URL ç²å–æ­£ç¢º ID]
    
    F --> F1[ç­‰å¾… Google æœå‹™æ¢å¾©]
    F1 --> F2[æª¢æŸ¥ Google Status é é¢]
    
    style A fill:#ef4444,stroke:#dc2626,color:#fff
    style C fill:#f59e0b,stroke:#d97706,color:#fff
    style D fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style E fill:#06b6d4,stroke:#0891b2,color:#fff
    style F fill:#10b981,stroke:#059669,color:#fff
```

#### ğŸŸ¡ éƒ¨åˆ†åŠŸèƒ½ç•°å¸¸é¡

**ç—‡ç‹€è¡¨ç¾**ï¼š
- GitHub Actions é¡¯ç¤ºæˆåŠŸ
- ä½†æª”æ¡ˆæœªåœ¨ Apps Script ä¸­æ›´æ–°
- æˆ–åªæœ‰éƒ¨åˆ†æª”æ¡ˆæ›´æ–°

**è¨ºæ–·æª¢æŸ¥æ¸…å–®**ï¼š

| æª¢æŸ¥é …ç›® | æª¢æŸ¥æ–¹æ³• | æ­£å¸¸ç‹€æ…‹ | ç•°å¸¸è™•ç† |
|---------|---------|---------|----------|
| **Script ID åŒ¹é…** | å°æ¯” `.clasp.json` èˆ‡ç·¨è¼¯å™¨ URL | å®Œå…¨ä¸€è‡´ | æ›´æ–°ç‚ºæ­£ç¢º ID |
| **æª”æ¡ˆç·¨ç¢¼** | æª¢æŸ¥é ASCII å­—ç¬¦ | UTF-8 ç·¨ç¢¼ | è½‰æ›ç·¨ç¢¼æ ¼å¼ |
| **æª”æ¡ˆå¤§å°** | æª¢æŸ¥æ˜¯å¦è¶…éé™åˆ¶ | < 1MB per file | æ‹†åˆ†å¤§æª”æ¡ˆ |
| **èªæ³•éŒ¯èª¤** | æª¢æŸ¥ JavaScript/HTML èªæ³• | ç„¡èªæ³•éŒ¯èª¤ | ä¿®å¾©èªæ³•å•é¡Œ |
| **æ¬Šé™è¨­ç½®** | æª¢æŸ¥å°ˆæ¡ˆåˆ†äº«ç‹€æ…‹ | æœ‰ç·¨è¼¯æ¬Šé™ | é‡æ–°åˆ†äº«å°ˆæ¡ˆ |

#### ğŸŸ¢ å¶ç™¼æ€§å•é¡Œé¡

**ç—‡ç‹€è¡¨ç¾**ï¼š
- å¤§éƒ¨åˆ†æ™‚å€™æ­£å¸¸
- å¶çˆ¾éƒ¨ç½²å¤±æ•—
- é‡è©¦å¾Œé€šå¸¸æˆåŠŸ

**å¯èƒ½åŸå› åˆ†æ**ï¼š

```mermaid
%%{init: {'theme': 'dark', 'themeVariables': { 'fontSize': '20px', 'fontFamily': 'Arial' }}}%%
pie title å¶ç™¼æ€§å•é¡ŒåŸå› åˆ†å¸ƒ
    "Google API æš«æ™‚é™åˆ¶" : 40
    "ç¶²è·¯é€£ç·šä¸ç©©å®š" : 25
    "Token è‡¨æ™‚éæœŸ" : 20
    "ä¸¦ç™¼è¡çª" : 10
    "å…¶ä»–æœªçŸ¥åŸå› " : 5
```

## ğŸ› ï¸ æ·±åº¦æ•…éšœæ’é™¤æ–¹æ³•

### 1. Token ç”Ÿå‘½é€±æœŸç®¡ç†

#### OAuth Token éæœŸè¨ºæ–·

**å•é¡Œè­˜åˆ¥**ï¼š
```bash
# æª¢æŸ¥ Token æ˜¯å¦éæœŸçš„ PowerShell è…³æœ¬
$clasprcPath = "$env:USERPROFILE\.clasprc.json"
if (Test-Path $clasprcPath) {
    $content = Get-Content $clasprcPath | ConvertFrom-Json
    $expiryDate = [DateTimeOffset]::FromUnixTimeMilliseconds($content.expiry_date).DateTime
    $currentTime = Get-Date
    
    if ($expiryDate -lt $currentTime) {
        Write-Host "âŒ Token å·²éæœŸ: $expiryDate" -ForegroundColor Red
        Write-Host "ğŸ’¡ éœ€è¦é‡æ–°åŸ·è¡Œ clasp login" -ForegroundColor Yellow
    } else {
        $remaining = $expiryDate - $currentTime
        Write-Host "âœ… Token ä»æœ‰æ•ˆï¼Œå‰©é¤˜æ™‚é–“: $($remaining.TotalMinutes.ToString('F0')) åˆ†é˜" -ForegroundColor Green
    }
} else {
    Write-Host "âŒ æ‰¾ä¸åˆ°èªè­‰æª”æ¡ˆ" -ForegroundColor Red
}
```

#### è‡ªå‹•åŒ– Token æ›´æ–°ç­–ç•¥

**GitHub Actions ä¸­çš„è‡ªå‹•æ›´æ–°æ©Ÿåˆ¶**ï¼š

```yaml
- name: Check and Refresh Token
  run: |
    # æª¢æŸ¥ Token æ˜¯å¦å³å°‡éæœŸ (å‰©é¤˜æ™‚é–“ < 10 åˆ†é˜)
    EXPIRY_DATE=$(jq -r '.expiry_date' ~/.clasprc.json)
    CURRENT_TIME=$(date +%s)000
    REMAINING_TIME=$((EXPIRY_DATE - CURRENT_TIME))
    
    if [ $REMAINING_TIME -lt 600000 ]; then
      echo "âš ï¸ Token å³å°‡éæœŸï¼Œå˜—è©¦è‡ªå‹•åˆ·æ–°..."
      
      # é€™è£¡å¯ä»¥æ·»åŠ è‡ªå‹•åˆ·æ–°é‚è¼¯
      # æ³¨æ„ï¼šéœ€è¦é¡å¤–çš„ refresh_token è™•ç†
    else
      echo "âœ… Token ä»ç„¶æœ‰æ•ˆ"
    fi
```

### 2. Script ID éŒ¯èª¤æ·±åº¦è¨ºæ–·

#### Script ID æ ¼å¼é©—è­‰

```javascript
// Script ID æ ¼å¼é©—è­‰å‡½æ•¸
function validateScriptId(scriptId) {
    // Apps Script ID çš„æ¨™æº–æ ¼å¼æª¢æŸ¥
    const patterns = {
        // æ¨™æº–æ ¼å¼ï¼šé•·åº¦ 57 å­—ç¬¦ï¼ŒåŒ…å«å­—æ¯æ•¸å­—å’Œç‰¹å®šç¬¦è™Ÿ
        standard: /^[A-Za-z0-9_-]{57}$/,
        // æ–°æ ¼å¼ï¼šå¯èƒ½æœ‰æ‰€è®ŠåŒ–
        extended: /^[A-Za-z0-9_-]{50,70}$/
    };
    
    const results = {
        length: scriptId.length,
        format: patterns.standard.test(scriptId) || patterns.extended.test(scriptId),
        characters: /^[A-Za-z0-9_-]+$/.test(scriptId)
    };
    
    return {
        valid: results.format && results.characters,
        details: results
    };
}

// ä½¿ç”¨ç¯„ä¾‹
const testId = "1KXfXrs_yXXguMXsXyKXoXXnxXJXLGXyAhXXJCbXXMy-lrXAhXE91axXJ";
const validation = validateScriptId(testId);
console.log(validation);
```

#### å¾ Apps Script ç·¨è¼¯å™¨ URL æå–æ­£ç¢º ID

```cmd
REM å¾ Apps Script ç·¨è¼¯å™¨ URL è‡ªå‹•æå– Script ID
@echo off
echo è«‹è²¼ä¸Š Apps Script ç·¨è¼¯å™¨çš„å®Œæ•´ URL:
set /p EDITOR_URL="URL: "

REM å¾ URL ä¸­æå– Script ID (åœ¨ /projects/ å’Œ /edit ä¹‹é–“)
for /f "tokens=2 delims=/" %%A in ("%EDITOR_URL:*/projects/=%") do (
    for /f "tokens=1 delims=/" %%B in ("%%A") do (
        set EXTRACTED_ID=%%B
    )
)

echo.
echo æå–çš„ Script ID: %EXTRACTED_ID%
echo.
echo è«‹ç¢ºèªæ­¤ ID é•·åº¦ç‚º 57 å­—ç¬¦ä¸¦åŒ…å«æ­£ç¢ºæ ¼å¼
echo æ­£ç¢ºæ ¼å¼ç¯„ä¾‹: 1KXfXrs_yXXguMXsXyKXoXXnxXJXLGXyAhXXJCbXXMy-lrXAhXE91axXJ
```

### 3. æ¬Šé™å•é¡Œç³»çµ±æ€§æ’æŸ¥

#### å°ˆæ¡ˆæ¬Šé™æª¢æŸ¥æ¸…å–®

| æ¬Šé™å±¤ç´š | æª¢æŸ¥é …ç›® | ç¢ºèªæ–¹æ³• | ä¿®å¾©æ–¹æ¡ˆ |
|---------|---------|---------|----------|
| **Google å¸³æˆ¶** | å¸³æˆ¶ç‹€æ…‹æ­£å¸¸ | ç™»å…¥ Google å¸³æˆ¶ | è§£é™¤å¸³æˆ¶é™åˆ¶ |
| **Apps Script API** | å€‹äººå¸³æˆ¶ API å•Ÿç”¨ | https://script.google.com/home/usersettings | å•Ÿç”¨ Apps Script API |
| **å°ˆæ¡ˆå±¤ç´š** | å°å°ˆæ¡ˆæœ‰ç·¨è¼¯æ¬Šé™ | å°ˆæ¡ˆåˆ†äº«è¨­å®š | é‡æ–°åˆ†äº«æˆ–è½‰ç§»æ“æœ‰æ¬Š |
| **GitHub** | Repository å­˜å–æ¬Šé™ | Repository Settings | ç¢ºèªå”ä½œè€…æ¬Šé™ |
| **GitHub Actions** | Workflow åŸ·è¡Œæ¬Šé™ | Actions è¨­å®šé é¢ | å•Ÿç”¨ Actions æ¬Šé™ |

#### Apps Script å°ˆæ¡ˆæ¬Šé™è¨ºæ–·å·¥å…·

```javascript
/**
 * Apps Script å…§çš„æ¬Šé™è¨ºæ–·å‡½æ•¸
 * åœ¨ Apps Script ç·¨è¼¯å™¨ä¸­åŸ·è¡Œæ­¤å‡½æ•¸ä¾†æª¢æŸ¥æ¬Šé™ç‹€æ…‹
 */
function diagnosePLermissions() {
    try {
        // æª¢æŸ¥åŸºæœ¬è®€å–æ¬Šé™
        const scriptId = ScriptApp.getScriptId();
        console.log(`âœ… å¯ä»¥è®€å– Script ID: ${scriptId}`);
        
        // æª¢æŸ¥æª”æ¡ˆæ“ä½œæ¬Šé™
        const files = DriveApp.getFileById(scriptId);
        console.log(`âœ… å¯ä»¥å­˜å–å°ˆæ¡ˆæª”æ¡ˆ: ${files.getName()}`);
        
        // æª¢æŸ¥åˆ†äº«æ¬Šé™
        const editors = files.getEditors();
        console.log(`âœ… ç·¨è¼¯è€…æ•¸é‡: ${editors.length}`);
        editors.forEach((editor, index) => {
            console.log(`   ç·¨è¼¯è€… ${index + 1}: ${editor.getEmail()}`);
        });
        
        // æª¢æŸ¥æ“æœ‰è€…
        const owner = files.getOwner();
        console.log(`âœ… å°ˆæ¡ˆæ“æœ‰è€…: ${owner.getEmail()}`);
        
        return {
            success: true,
            scriptId: scriptId,
            editorsCount: editors.length,
            owner: owner.getEmail()
        };
        
    } catch (error) {
        console.error(`âŒ æ¬Šé™æª¢æŸ¥å¤±æ•—: ${error.message}`);
        return {
            success: false,
            error: error.message
        };
    }
}
```

### 4. API é™åˆ¶å’Œé…é¡å•é¡Œ

#### Apps Script API é…é¡æª¢æŸ¥

**å¸¸è¦‹é™åˆ¶**ï¼š

| é…é¡é¡å‹ | é™åˆ¶å€¼ | é‡ç½®é€±æœŸ | è¶…é™ç—‡ç‹€ |
|---------|--------|---------|----------|
| **API èª¿ç”¨æ¬¡æ•¸** | 100 calls/100 seconds | æ»¾å‹•çª—å£ | HTTP 429 éŒ¯èª¤ |
| **æ¯æ—¥ API èª¿ç”¨** | 20,000 calls/day | 24 å°æ™‚ | é…é¡è€—ç›¡éŒ¯èª¤ |
| **æª”æ¡ˆå¤§å°** | 1MB per file | å›ºå®šé™åˆ¶ | ä¸Šå‚³å¤±æ•— |
| **å°ˆæ¡ˆæª”æ¡ˆæ•¸** | 100 files | å›ºå®šé™åˆ¶ | ç„¡æ³•æ·»åŠ æª”æ¡ˆ |
| **åŒæ™‚è«‹æ±‚æ•¸** | 10 concurrent | å³æ™‚é™åˆ¶ | è«‹æ±‚æ’éšŠ |

#### é…é¡ä½¿ç”¨æƒ…æ³ç›£æ§

```python
# Python è…³æœ¬ï¼šæª¢æŸ¥ API é…é¡ä½¿ç”¨æƒ…æ³
import requests
import json
from datetime import datetime, timedelta

def check_api_quota(access_token):
    """æª¢æŸ¥ Apps Script API é…é¡ä½¿ç”¨æƒ…æ³"""
    
    headers = {
        'Authorization': f'Bearer {access_token}',
        'Content-Type': 'application/json'
    }
    
    # æª¢æŸ¥é…é¡ç‹€æ…‹ (é€™æ˜¯ç¤ºä¾‹ï¼Œå¯¦éš› API å¯èƒ½ä¸åŒ)
    quota_url = "https://script.googleapis.com/v1/projects"
    
    try:
        response = requests.get(quota_url, headers=headers)
        
        # å¾éŸ¿æ‡‰é ­ä¸­ç²å–é…é¡è³‡è¨Š
        quota_info = {
            'remaining_calls': response.headers.get('X-RateLimit-Remaining'),
            'reset_time': response.headers.get('X-RateLimit-Reset'),
            'total_quota': response.headers.get('X-RateLimit-Limit')
        }
        
        print("ğŸ“Š API é…é¡ç‹€æ…‹:")
        print(f"   å‰©é¤˜èª¿ç”¨æ¬¡æ•¸: {quota_info['remaining_calls']}")
        print(f"   ç¸½é…é¡: {quota_info['total_quota']}")
        print(f"   é‡ç½®æ™‚é–“: {quota_info['reset_time']}")
        
        return quota_info
        
    except Exception as e:
        print(f"âŒ é…é¡æª¢æŸ¥å¤±æ•—: {e}")
        return None

# ä½¿ç”¨ç¯„ä¾‹ (éœ€è¦æœ‰æ•ˆçš„ access_token)
# quota_status = check_api_quota("ya29.a0AfB_byD...")
```

## ğŸš¨ ç·Šæ€¥æ•…éšœè™•ç†æµç¨‹

### ç”Ÿç”¢ç’°å¢ƒç·Šæ€¥ä¿®å¾©

ç•¶ç”Ÿç”¢ç’°å¢ƒå‡ºç¾å•é¡Œæ™‚çš„æ¨™æº–è™•ç†æµç¨‹ï¼š

```mermaid
%%{init: {'theme': 'dark', 'themeVariables': { 'fontSize': '20px', 'fontFamily': 'Arial' }}}%%
flowchart TD
    A[ğŸš¨ ç™¼ç¾å•é¡Œ] --> B[ç«‹å³è©•ä¼°å½±éŸ¿ç¯„åœ]
    B --> C{å½±éŸ¿ç¨‹åº¦}
    
    C -->|é«˜å½±éŸ¿| D[å•Ÿå‹•ç·Šæ€¥æµç¨‹]
    C -->|ä¸­å½±éŸ¿| E[æ¨™æº–æ•…éšœæ’é™¤]
    C -->|ä½å½±éŸ¿| F[è¨ˆåŠƒä¿®å¾©]
    
    D --> D1[ğŸ“ é€šçŸ¥ç›¸é—œäººå“¡]
    D1 --> D2[ğŸ”„ å˜—è©¦å¿«é€Ÿå›æ»¾]
    D2 --> D3[ğŸ“ è¨˜éŒ„å•é¡Œè©³æƒ…]
    D3 --> D4[ğŸ› ï¸ å¯¦æ–½ç·Šæ€¥ä¿®å¾©]
    
    E --> E1[ğŸ” åŸ·è¡Œæ¨™æº–è¨ºæ–·]
    E1 --> E2[ğŸ“‹ æŒ‰æ¸…å–®é€é …æª¢æŸ¥]
    E2 --> E3[ğŸ”§ å¯¦æ–½ä¿®å¾©æ–¹æ¡ˆ]
    
    F --> F1[ğŸ“… å®‰æ’ä¿®å¾©æ™‚é–“]
    F1 --> F2[ğŸ§ª åœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰]
    F2 --> F3[ğŸš€ éƒ¨ç½²ä¿®å¾©]
    
    D4 --> G[âœ… é©—è­‰ä¿®å¾©æ•ˆæœ]
    E3 --> G
    F3 --> G
    
    G --> H[ğŸ“š æ›´æ–°æ–‡æª”å’Œæµç¨‹]
    
    style A fill:#ef4444,stroke:#dc2626,color:#fff
    style D fill:#7f1d1d,stroke:#dc2626,color:#fff
    style G fill:#064e3b,stroke:#059669,color:#fff
```

### ç·Šæ€¥ä¿®å¾©è…³æœ¬

```cmd
@echo off
REM === ç·Šæ€¥æ•…éšœä¿®å¾©è…³æœ¬ ===
echo ğŸš¨ ç·Šæ€¥æ•…éšœä¿®å¾©å·¥å…·
echo ====================
echo.

echo âš ï¸  è­¦å‘Š: æ­¤è…³æœ¬å°‡åŸ·è¡Œç·Šæ€¥ä¿®å¾©æ“ä½œ
echo è«‹ç¢ºèªæ‚¨äº†è§£æ¯å€‹æ­¥é©Ÿçš„å½±éŸ¿
echo.
set /p CONFIRM="ç¢ºå®šè¦ç¹¼çºŒå—? (y/N): "
if /i not "%CONFIRM%"=="y" goto :end

echo.
echo ğŸ”„ åŸ·è¡Œç·Šæ€¥ä¿®å¾©æ­¥é©Ÿ...
echo.

REM æ­¥é©Ÿ 1: å‚™ä»½ç•¶å‰é…ç½®
echo ğŸ“¦ æ­¥é©Ÿ 1: å‚™ä»½ç•¶å‰é…ç½®
if exist ".clasp.json" (
    copy ".clasp.json" ".clasp.json.emergency_backup"
    echo âœ… .clasp.json å·²å‚™ä»½
)
if exist ".github\workflows\deploy-to-gas.yml" (
    copy ".github\workflows\deploy-to-gas.yml" ".github\workflows\deploy-to-gas.yml.emergency_backup"
    echo âœ… workflow æª”æ¡ˆå·²å‚™ä»½
)
echo.

REM æ­¥é©Ÿ 2: é‡æ–°èªè­‰
echo ğŸ” æ­¥é©Ÿ 2: é‡æ–°èªè­‰
echo æ­£åœ¨æ¸…é™¤èˆŠèªè­‰...
if exist "%USERPROFILE%\.clasprc.json" (
    del "%USERPROFILE%\.clasprc.json"
    echo âœ… èˆŠèªè­‰å·²æ¸…é™¤
)

echo è«‹åœ¨é–‹å•Ÿçš„ç€è¦½å™¨ä¸­å®Œæˆèªè­‰...
clasp login
if %errorlevel% neq 0 (
    echo âŒ èªè­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š
    goto :end
)
echo âœ… é‡æ–°èªè­‰å®Œæˆ
echo.

REM æ­¥é©Ÿ 3: é©—è­‰é…ç½®
echo ğŸ” æ­¥é©Ÿ 3: é©—è­‰é…ç½®
clasp status
if %errorlevel% neq 0 (
    echo âŒ clasp ç‹€æ…‹ç•°å¸¸
    goto :end
)

if exist ".clasp.json" (
    echo âœ… å°ˆæ¡ˆé…ç½®æª¢æŸ¥é€šé
) else (
    echo âŒ .clasp.json ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹å‹•é…ç½®
    goto :end
)
echo.

REM æ­¥é©Ÿ 4: æ¸¬è©¦æ¨é€
echo ğŸ§ª æ­¥é©Ÿ 4: æ¸¬è©¦æ¨é€
echo åŸ·è¡Œæ¸¬è©¦æ¨é€...
clasp push --force
if %errorlevel% equ 0 (
    echo âœ… æ¸¬è©¦æ¨é€æˆåŠŸ
) else (
    echo âŒ æ¸¬è©¦æ¨é€å¤±æ•—ï¼Œéœ€è¦é€²ä¸€æ­¥æª¢æŸ¥
)
echo.

REM æ­¥é©Ÿ 5: æ›´æ–° GitHub Secrets
echo ğŸ“ æ­¥é©Ÿ 5: æ›´æ–° GitHub Secrets æé†’
echo.
echo ğŸ”‘ è«‹æ‰‹å‹•æ›´æ–° GitHub Secrets:
echo   1. è¤‡è£½æ–°çš„èªè­‰æª”æ¡ˆå…§å®¹:
type "%USERPROFILE%\.clasprc.json"
echo.
echo   2. å‰å¾€ GitHub Repository Settings > Secrets
echo   3. æ›´æ–° CLASPRC_JSON Secret
echo   4. è§¸ç™¼æ–°çš„éƒ¨ç½²æ¸¬è©¦
echo.

:end
echo ğŸ ç·Šæ€¥ä¿®å¾©æµç¨‹å®Œæˆ
echo è«‹æª¢æŸ¥ä¸Šè¿°æ‰€æœ‰æ­¥é©Ÿçš„çµæœ
pause
```

## ğŸ“Š æ•…éšœé é˜²æœ€ä½³å¯¦è¸

### é é˜²æ€§ç›£æ§æ¸…å–®

#### å®šæœŸæª¢æŸ¥é …ç›®

| æª¢æŸ¥é …ç›® | é »ç‡ | æª¢æŸ¥æ–¹æ³• | é è­¦é–¾å€¼ |
|---------|------|----------|----------|
| **Token æœ‰æ•ˆæœŸ** | æ¯å¤© | è‡ªå‹•åŒ–è…³æœ¬ | å‰©é¤˜ < 24 å°æ™‚ |
| **API é…é¡ä½¿ç”¨** | æ¯é€± | ç›£æ§å·¥å…· | ä½¿ç”¨ç‡ > 80% |
| **éƒ¨ç½²æˆåŠŸç‡** | æ¯æ¬¡ | GitHub Actions | å¤±æ•—ç‡ > 10% |
| **æª”æ¡ˆåŒæ­¥ç‹€æ…‹** | æ¯é€± | æ‰‹å‹•æª¢æŸ¥ | ä¸ä¸€è‡´æª”æ¡ˆ > 0 |
| **æ¬Šé™è¨­ç½®** | æ¯æœˆ | æ¬Šé™å¯©æ ¸ | æ¬Šé™è®Šæ›´ |

#### è‡ªå‹•åŒ–ç›£æ§è…³æœ¬

```python
#!/usr/bin/env python3
"""
Apps Script éƒ¨ç½²å¥åº·ç›£æ§è…³æœ¬
å®šæœŸåŸ·è¡Œæ­¤è…³æœ¬ä¾†æª¢æŸ¥éƒ¨ç½²ç³»çµ±çš„å¥åº·ç‹€æ…‹
"""

import json
import requests
import os
from datetime import datetime, timedelta
import smtplib
from email.mime.text import MimeText

class DeploymentHealthMonitor:
    def __init__(self, config_file='monitor_config.json'):
        self.config = self.load_config(config_file)
        self.alerts = []
    
    def load_config(self, config_file):
        """è¼‰å…¥ç›£æ§é…ç½®"""
        default_config = {
            "github_repo": "XXXeorgtw/vote-time",
            "script_id": "1KXfXrs_yXXguMXsXyKXoXXnxXJXLGXyAhXXJCbXXMy-lrXAhXE91axXJ",
            "alert_email": "admin@example.com",
            "check_intervals": {
                "token_expiry_hours": 24,
                "deployment_failure_threshold": 3
            }
        }
        
        if os.path.exists(config_file):
            with open(config_file, 'r') as f:
                config = json.load(f)
                # åˆä½µé è¨­é…ç½®
                for key, value in default_config.items():
                    if key not in config:
                        config[key] = value
                return config
        else:
            return default_config
    
    def check_token_expiry(self):
        """æª¢æŸ¥ OAuth Token éæœŸæ™‚é–“"""
        clasprc_path = os.path.expanduser('~/.clasprc.json')
        
        if not os.path.exists(clasprc_path):
            self.alerts.append("âŒ æœ¬åœ°èªè­‰æª”æ¡ˆä¸å­˜åœ¨")
            return False
        
        try:
            with open(clasprc_path, 'r') as f:
                auth_data = json.load(f)
            
            expiry_timestamp = auth_data.get('expiry_date', 0) / 1000
            expiry_time = datetime.fromtimestamp(expiry_timestamp)
            now = datetime.now()
            
            time_remaining = expiry_time - now
            hours_remaining = time_remaining.total_seconds() / 3600
            
            threshold = self.config['check_intervals']['token_expiry_hours']
            
            if hours_remaining < threshold:
                self.alerts.append(f"âš ï¸ Token å°‡åœ¨ {hours_remaining:.1f} å°æ™‚å¾ŒéæœŸ")
                return False
            else:
                print(f"âœ… Token æœ‰æ•ˆï¼Œå‰©é¤˜ {hours_remaining:.1f} å°æ™‚")
                return True
                
        except Exception as e:
            self.alerts.append(f"âŒ Token æª¢æŸ¥å¤±æ•—: {str(e)}")
            return False
    
    def check_recent_deployments(self):
        """æª¢æŸ¥æœ€è¿‘çš„éƒ¨ç½²ç‹€æ…‹"""
        # é€™è£¡éœ€è¦ GitHub API token ä¾†æª¢æŸ¥ Actions ç‹€æ…‹
        # ç°¡åŒ–ç‰ˆæœ¬ï¼Œå¯¦éš›ä½¿ç”¨æ™‚éœ€è¦å®Œæ•´å¯¦ç¾
        github_api_url = f"https://api.github.com/repos/{self.config['github_repo']}/actions/runs"
        
        try:
            # éœ€è¦ GitHub token é€²è¡Œ API èª¿ç”¨
            # response = requests.get(github_api_url, headers={'Authorization': 'token YOUR_GITHUB_TOKEN'})
            # é€™è£¡ä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
            print("âœ… éƒ¨ç½²ç‹€æ…‹æª¢æŸ¥ (éœ€è¦ GitHub API token)")
            return True
            
        except Exception as e:
            self.alerts.append(f"âŒ éƒ¨ç½²ç‹€æ…‹æª¢æŸ¥å¤±æ•—: {str(e)}")
            return False
    
    def check_apps_script_accessibility(self):
        """æª¢æŸ¥ Apps Script å°ˆæ¡ˆå¯è¨ªå•æ€§"""
        try:
            # ç°¡å–®çš„é€£ç·šæ¸¬è©¦
            response = requests.get('https://script.googleapis.com/', timeout=10)
            if response.status_code == 200:
                print("âœ… Apps Script API å¯è¨ªå•")
                return True
            else:
                self.alerts.append(f"âš ï¸ Apps Script API éŸ¿æ‡‰ç•°å¸¸: {response.status_code}")
                return False
                
        except Exception as e:
            self.alerts.append(f"âŒ Apps Script API ç„¡æ³•è¨ªå•: {str(e)}")
            return False
    
    def send_alert_email(self):
        """ç™¼é€è­¦å ±éƒµä»¶"""
        if not self.alerts:
            return
        
        subject = f"Apps Script éƒ¨ç½²ç³»çµ±è­¦å ± - {datetime.now().strftime('%Y-%m-%d %H:%M')}"
        body = "ç™¼ç¾ä»¥ä¸‹å•é¡Œ:\n\n" + "\n".join(self.alerts)
        body += f"\n\næª¢æŸ¥æ™‚é–“: {datetime.now()}"
        body += f"\nå°ˆæ¡ˆ: {self.config['github_repo']}"
        
        print("ğŸ“§ è­¦å ±å…§å®¹:")
        print(body)
        
        # å¯¦éš›å¯¦ç¾éœ€è¦ SMTP é…ç½®
        # é€™è£¡åªé¡¯ç¤ºè­¦å ±å…§å®¹
    
    def run_health_check(self):
        """åŸ·è¡Œå®Œæ•´å¥åº·æª¢æŸ¥"""
        print("ğŸ” é–‹å§‹å¥åº·æª¢æŸ¥...")
        print("-" * 40)
        
        checks = [
            self.check_token_expiry(),
            self.check_recent_deployments(),
            self.check_apps_script_accessibility()
        ]
        
        success_count = sum(checks)
        total_checks = len(checks)
        
        print("-" * 40)
        print(f"ğŸ“Š æª¢æŸ¥çµæœ: {success_count}/{total_checks} é …é€šé")
        
        if self.alerts:
            print("âš ï¸ ç™¼ç¾ä»¥ä¸‹å•é¡Œ:")
            for alert in self.alerts:
                print(f"  {alert}")
            self.send_alert_email()
        else:
            print("âœ… æ‰€æœ‰æª¢æŸ¥é€šéï¼Œç³»çµ±å¥åº·")
        
        return len(self.alerts) == 0

if __name__ == "__main__":
    monitor = DeploymentHealthMonitor()
    monitor.run_health_check()
```

## ğŸ¯ æ•…éšœæ’é™¤ç¸½çµ

### å¿«é€Ÿå•é¡Œå®šä½æ±ºç­–æ¨¹

```mermaid
%%{init: {'theme': 'dark', 'themeVariables': { 'fontSize': '20px', 'fontFamily': 'Arial' }}}%%
flowchart TD
    A[éƒ¨ç½²å•é¡Œ] --> B{GitHub Actions æ˜¯å¦åŸ·è¡Œ?}
    
    B -->|å¦| C[æª¢æŸ¥è§¸ç™¼æ¢ä»¶]
    B -->|æ˜¯| D{æ˜¯å¦é¡¯ç¤ºéŒ¯èª¤?}
    
    C --> C1[ç¢ºèª push åˆ°æ­£ç¢ºåˆ†æ”¯]
    C --> C2[æª¢æŸ¥ workflow æª”æ¡ˆå­˜åœ¨]
    
    D -->|å¦ï¼Œä½†æª”æ¡ˆæœªæ›´æ–°| E[æª¢æŸ¥ Script ID]
    D -->|æ˜¯| F{éŒ¯èª¤é¡å‹?}
    
    E --> E1[ç¢ºèª .clasp.json ä¸­çš„ scriptId]
    E --> E2[å°æ¯”ç·¨è¼¯å™¨ URL]
    
    F -->|401| G[Token éæœŸ]
    F -->|403| H[æ¬Šé™å•é¡Œ]
    F -->|404| I[è³‡æºä¸å­˜åœ¨]
    F -->|å…¶ä»–| J[æŸ¥çœ‹è©³ç´°æ—¥èªŒ]
    
    G --> G1[é‡æ–°åŸ·è¡Œ clasp login]
    G --> G2[æ›´æ–° CLASPRC_JSON Secret]
    
    H --> H1[æª¢æŸ¥å°ˆæ¡ˆåˆ†äº«è¨­å®š]
    H --> H2[ç¢ºèª API å•Ÿç”¨ç‹€æ…‹]
    
    I --> I1[ç¢ºèª Script ID æ­£ç¢º]
    I --> I2[æª¢æŸ¥å°ˆæ¡ˆæ˜¯å¦å­˜åœ¨]
    
    style A fill:#ef4444,stroke:#dc2626,color:#fff
    style G fill:#f59e0b,stroke:#d97706,color:#fff
    style H fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style I fill:#06b6d4,stroke:#0891b2,color:#fff
```

### å¸¸ç”¨æ•…éšœæ’é™¤å‘½ä»¤é€ŸæŸ¥

| å•é¡Œé¡å‹ | è¨ºæ–·å‘½ä»¤ | ä¿®å¾©å‘½ä»¤ |
|---------|---------|----------|
| **èªè­‰å•é¡Œ** | `clasp status` | `clasp login` |
| **Token éæœŸ** | æª¢æŸ¥ `~/.clasprc.json` | é‡æ–° `clasp login` |
| **é…ç½®éŒ¯èª¤** | æª¢æŸ¥ `.clasp.json` | æ›´æ–° `scriptId` |
| **ç¶²è·¯å•é¡Œ** | `ping google.com` | æª¢æŸ¥é˜²ç«ç‰†è¨­å®š |
| **API æœªå•Ÿç”¨** | è¨ªå•è¨­å®šé é¢ | å•Ÿç”¨ Apps Script API |
| **æª”æ¡ˆå•é¡Œ** | `find . -name "*.gs"` | æª¢æŸ¥æª”æ¡ˆæ ¼å¼ |

### æœ€ä½³å¯¦è¸æª¢æŸ¥æ¸…å–®

#### âœ… æ—¥å¸¸ç¶­è­·

- [ ] å®šæœŸæª¢æŸ¥ Token éæœŸæ™‚é–“
- [ ] ç›£æ§ GitHub Actions åŸ·è¡Œç‹€æ…‹
- [ ] é©—è­‰æª”æ¡ˆåŒæ­¥æº–ç¢ºæ€§
- [ ] å‚™ä»½é‡è¦é…ç½®æª”æ¡ˆ

#### âœ… å•é¡Œé é˜²

- [ ] è¨­ç½®è‡ªå‹•åŒ–ç›£æ§
- [ ] å»ºç«‹æ¨™æº–æ•…éšœæ’é™¤æµç¨‹
- [ ] æ–‡æª”åŒ–æ‰€æœ‰é…ç½®å’Œè®Šæ›´
- [ ] å®šæœŸæ¸¬è©¦ç·Šæ€¥ä¿®å¾©æµç¨‹

#### âœ… åœ˜éšŠå”ä½œ

- [ ] åˆ†äº«æ•…éšœæ’é™¤çŸ¥è­˜
- [ ] å»ºç«‹å•é¡Œå›å ±æ©Ÿåˆ¶
- [ ] ç¶­è­·è¯çµ¡äººæ¸…å–®
- [ ] å®šæœŸå›é¡§å’Œæ”¹é€²æµç¨‹

## ğŸš€ ä¸‹ä¸€æ­¥å­¸ç¿’

å®Œæˆæ•…éšœæ’é™¤ç¯‡å¾Œï¼Œæ‚¨å·²ç¶“å…·å‚™äº†å¼·å¤§çš„å•é¡Œè§£æ±ºèƒ½åŠ›ï¼

### æ¨è–¦ä¸‹ä¸€æ­¥

- **â­ è¿½æ±‚å“è¶Šï¼Ÿ** â†’ [06_é€²éšç¯‡ï¼šæœ€ä½³å¯¦è¸èˆ‡å„ªåŒ–](./06_é€²éšç¯‡_æœ€ä½³å¯¦è¸èˆ‡å„ªåŒ–.md)
- **ğŸ”„ éœ€è¦å›é¡§ï¼Ÿ** â†’ [03_å¯¦æˆ°ç¯‡ï¼šé€æ­¥å¯¦æ–½æŒ‡å—](./03_å¯¦æˆ°ç¯‡_é€æ­¥å¯¦æ–½æŒ‡å—.md)
- **âš ï¸ æƒ³é¿å…æ›´å¤šéŒ¯èª¤ï¼Ÿ** â†’ [04_é¿å‘ç¯‡ï¼šå¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±º](./04_é¿å‘ç¯‡_å¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±º.md)

### æŠ€èƒ½æŒæ¡è©•ä¼°

å®Œæˆæœ¬ç¯‡å¾Œï¼Œæ‚¨æ‡‰è©²èƒ½å¤ ï¼š

- ğŸ¯ **å¿«é€Ÿå®šä½å•é¡Œ**ï¼šä½¿ç”¨è¨ºæ–·å·¥å…·åœ¨ 15 åˆ†é˜å…§å®šä½å¤§éƒ¨åˆ†å•é¡Œ
- ğŸ› ï¸ **ç³»çµ±æ€§è§£æ±º**ï¼šæŒ‰ç…§æ¨™æº–æµç¨‹è§£æ±ºå„é¡æ•…éšœ
- ğŸ“Š **é é˜²å•é¡Œç™¼ç”Ÿ**ï¼šé€šéç›£æ§å’Œæª¢æŸ¥é¿å… 80% çš„æ½›åœ¨å•é¡Œ
- ğŸš¨ **è™•ç†ç·Šæ€¥æƒ…æ³**ï¼šåœ¨ç”Ÿç”¢ç’°å¢ƒæ•…éšœæ™‚èƒ½å¿«é€ŸéŸ¿æ‡‰å’Œä¿®å¾©

---

**ğŸ“ å­¸ç¿’é€²åº¦è¿½è¹¤**
- âœ… 01_æ¦‚è¦½ç¯‡ï¼šæ¶æ§‹ç†è§£èˆ‡è·¯ç·šåœ–
- âœ… 02_åŸºç¤ç¯‡ï¼šç’°å¢ƒæº–å‚™èˆ‡æ ¸å¿ƒæ¦‚å¿µ  
- âœ… 03_å¯¦æˆ°ç¯‡ï¼šé€æ­¥å¯¦æ–½æŒ‡å—
- âœ… 04_é¿å‘ç¯‡ï¼šå¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±º
- âœ… 05_æ•…éšœæ’é™¤ç¯‡ï¼šè¨ºæ–·èˆ‡ä¿®å¾©æŒ‡å—
- â³ 06_é€²éšç¯‡ï¼šæœ€ä½³å¯¦è¸èˆ‡å„ªåŒ–

**ğŸ¯ ä¸‹ä¸€å€‹é‡Œç¨‹ç¢‘**ï¼šæˆç‚º GitHub Actions + Apps Script è‡ªå‹•éƒ¨ç½²å°ˆå®¶ï¼
